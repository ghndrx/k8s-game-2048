name: Promote to Production

on:
  workflow_run:
    workflows: ["Smoke Tests"]
    types:
      - completed
    branches: [ staging ]

jobs:
  test-staging-and-promote-to-main:
    name: Test Staging and Promote to Main
    runs-on: ubuntu-latest
    environment: staging
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: staging

    - name: Wait for staging smoke test results to settle
      run: |
        echo "â³ Staging smoke tests completed, proceeding with production promotion..."
        sleep 30

    - name: Verify staging smoke tests passed
      run: |
        echo "âœ… Staging smoke tests passed - proceeding with auto-promotion to production"

    - name: Auto-promote staging to main branch
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('ðŸŽ¯ All staging smoke tests passed! Auto-promoting staging to main branch...');
          
          // Create a merge from staging to main
          try {
            const response = await github.rest.repos.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: 'staging',
              commit_message: 'Auto-promote: Merge staging to main after successful staging tests - Deploy to Production'
            });
            
            console.log('âœ… Successfully merged staging to main branch');
            console.log('This will trigger production deployment automatically');
            
            return response;
          } catch (error) {
            if (error.status === 409) {
              console.log('â„¹ï¸ No new commits to merge - main is already up to date');
            } else {
              throw error;
            }
          }

    - name: Create production promotion summary
      run: |
        echo "## ðŸŽ‰ Production Promotion Summary (Staging â†’ Main)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status | Action |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Staging Tests | âœ… Passed | Comprehensive validation completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Main Branch | ðŸš€ Updated | Auto-promotion completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Production Deploy | â³ Triggered | Deployment will start automatically |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Tests Performed" >> $GITHUB_STEP_SUMMARY
        echo "- Staging canonical domain accessibility" >> $GITHUB_STEP_SUMMARY
        echo "- Staging custom domain accessibility" >> $GITHUB_STEP_SUMMARY
        echo "- Content and functionality validation" >> $GITHUB_STEP_SUMMARY
        echo "- Performance testing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ® Deployment Status" >> $GITHUB_STEP_SUMMARY
        
        # Use canonical domain format (these are the Knative domains)
        DEV_URL="https://game-2048-dev.game-2048-dev.dev.wa.darknex.us"
        STAGING_URL="https://game-2048-staging.game-2048-staging.staging.wa.darknex.us"
        PROD_URL="https://game-2048-prod.game-2048-prod.wa.darknex.us"
        
        echo "- **Development**: âœ… Live at $DEV_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **Staging**: âœ… Live at $STAGING_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **Production**: ðŸš€ Deploying to $PROD_URL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Production deployment will start automatically" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor the production deployment workflow" >> $GITHUB_STEP_SUMMARY
        echo "- All environments will be live with the latest code!" >> $GITHUB_STEP_SUMMARY
